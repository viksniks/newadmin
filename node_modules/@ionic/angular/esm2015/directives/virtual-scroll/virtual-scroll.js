import * as tslib_1 from "tslib";
import { ChangeDetectionStrategy, Component, ContentChild, ElementRef, EmbeddedViewRef, IterableDiffer, IterableDiffers, NgZone, SimpleChanges, TrackByFunction } from '@angular/core';
import { ProxyCmp } from '../proxies-utils';
import { VirtualFooter } from './virtual-footer';
import { VirtualHeader } from './virtual-header';
import { VirtualItem } from './virtual-item';
import * as ɵngcc0 from '@angular/core';

const _c0 = ["*"];
let IonVirtualScroll = class IonVirtualScroll {
    constructor(z, iterableDiffers, elementRef) {
        this.z = z;
        this.iterableDiffers = iterableDiffers;
        this.refMap = new WeakMap();
        this.el = elementRef.nativeElement;
        this.el.nodeRender = this.nodeRender.bind(this);
    }
    ngOnChanges(changes) {
        if (this.trackBy && 'items' in changes) {
            // React on virtualScroll changes only once all inputs have been initialized
            const value = changes['items'].currentValue;
            if (this.differ === undefined && value != null) {
                try {
                    this.differ = this.iterableDiffers.find(value).create(this.trackBy);
                }
                catch (e) {
                    throw new Error(`Cannot find a differ supporting object '${value}'. VirtualScroll only supports binding to Iterables such as Arrays.`);
                }
            }
        }
    }
    ngDoCheck() {
        // and if there actually are changes
        const changes = this.differ !== undefined && this.items ? this.differ.diff(this.items) : null;
        if (changes === null) {
            return;
        }
        // TODO: optimize
        this.checkRange(0);
    }
    nodeRender(el, cell, index) {
        return this.z.run(() => {
            let node;
            if (!el) {
                node = this.itmTmp.viewContainer.createEmbeddedView(this.getComponent(cell.type), { $implicit: cell.value, index }, index);
                el = getElement(node);
                this.refMap.set(el, node);
            }
            else {
                node = this.refMap.get(el);
                const ctx = node.context;
                ctx.$implicit = cell.value;
                ctx.index = cell.index;
            }
            // run sync change detections
            node.detectChanges();
            return el;
        });
    }
    getComponent(type) {
        switch (type) {
            case 'item': return this.itmTmp.templateRef;
            case 'header': return this.hdrTmp.templateRef;
            case 'footer': return this.ftrTmp.templateRef;
        }
        throw new Error('template for virtual item was not provided');
    }
};
IonVirtualScroll.ɵfac = function IonVirtualScroll_Factory(t) { return new (t || IonVirtualScroll)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.IterableDiffers), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
IonVirtualScroll.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: IonVirtualScroll, selectors: [["ion-virtual-scroll"]], contentQueries: function IonVirtualScroll_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualItem, true);
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualHeader, true);
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualFooter, true);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.itmTmp = _t.first);
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.hdrTmp = _t.first);
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.ftrTmp = _t.first);
    } }, inputs: { approxItemHeight: "approxItemHeight", approxHeaderHeight: "approxHeaderHeight", approxFooterHeight: "approxFooterHeight", headerFn: "headerFn", footerFn: "footerFn", items: "items", itemHeight: "itemHeight", headerHeight: "headerHeight", footerHeight: "footerHeight", trackBy: "trackBy" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], ngContentSelectors: _c0, decls: 1, vars: 0, template: function IonVirtualScroll_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
    } }, encapsulation: 2, changeDetection: 0 });
IonVirtualScroll.ctorParameters = () => [
    { type: NgZone },
    { type: IterableDiffers },
    { type: ElementRef }
];
tslib_1.__decorate([
    ContentChild(VirtualItem, { static: false })
], IonVirtualScroll.prototype, "itmTmp", void 0);
tslib_1.__decorate([
    ContentChild(VirtualHeader, { static: false })
], IonVirtualScroll.prototype, "hdrTmp", void 0);
tslib_1.__decorate([
    ContentChild(VirtualFooter, { static: false })
], IonVirtualScroll.prototype, "ftrTmp", void 0);
IonVirtualScroll = tslib_1.__decorate([
    ProxyCmp({
        inputs: ['approxItemHeight', 'approxHeaderHeight', 'approxFooterHeight', 'headerFn', 'footerFn', 'items', 'itemHeight', 'headerHeight', 'footerHeight'],
        methods: ['checkEnd', 'checkRange', 'positionForItem']
    }),
], IonVirtualScroll);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IonVirtualScroll, [{
        type: Component,
        args: [{
                selector: 'ion-virtual-scroll',
                template: '<ng-content></ng-content>',
                changeDetection: ChangeDetectionStrategy.OnPush,
                inputs: [
                    'approxItemHeight',
                    'approxHeaderHeight',
                    'approxFooterHeight',
                    'headerFn',
                    'footerFn',
                    'items',
                    'itemHeight',
                    'headerHeight',
                    'footerHeight',
                    'trackBy'
                ]
            }]
    }], function () { return [{ type: ɵngcc0.NgZone }, { type: ɵngcc0.IterableDiffers }, { type: ɵngcc0.ElementRef }]; }, { itmTmp: [{
            type: ContentChild,
            args: [VirtualItem, { static: false }]
        }], hdrTmp: [{
            type: ContentChild,
            args: [VirtualHeader, { static: false }]
        }], ftrTmp: [{
            type: ContentChild,
            args: [VirtualFooter, { static: false }]
        }] }); })();
export { IonVirtualScroll };
const getElement = (view) => {
    const rootNodes = view.rootNodes;
    for (let i = 0; i < rootNodes.length; i++) {
        if (rootNodes[i].nodeType === 1) {
            return rootNodes[i];
        }
    }
    throw new Error('virtual element was not created');
};
const ɵ0 = getElement;
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1zY3JvbGwuanMiLCJzb3VyY2VzIjpbIkBpb25pYy9hbmd1bGFyL2RpcmVjdGl2ZXMvdmlydHVhbC1zY3JvbGwvdmlydHVhbC1zY3JvbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUd2TCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFNUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFnSTdDLElBQWEsZ0JBQWdCLEdBQTdCLE1BQWEsZ0JBQWdCO0FBQzdCLElBU0UsWUFDVSxDQUFTLEVBQ1QsZUFBZ0MsRUFDeEMsVUFBc0I7QUFDeEIsUUFIVSxNQUFDLEdBQUQsQ0FBQyxDQUFRO0FBQUMsUUFDVixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7QUFBQyxRQVJuQyxXQUFNLEdBQUcsSUFBSSxPQUFPLEVBQWdELENBQUM7QUFDL0UsUUFVSSxJQUFJLENBQUMsRUFBRSxHQUFHLFVBQVUsQ0FBQyxhQUE0QyxDQUFDO0FBQ3RFLFFBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEQsSUFBRSxDQUFDO0FBQ0gsSUFDRSxXQUFXLENBQUMsT0FBc0I7QUFBSSxRQUNwQyxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksT0FBTyxJQUFJLE9BQU8sRUFBRTtBQUM1QyxZQUFNLDRFQUE0RTtBQUNsRixZQUFNLE1BQU0s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NkVEO0FBQ0EsU0E3RWEsZ0JBQWdCO0FBNkU3QixNQUFNLFVBQVUsR0FBRyxDQUFDLElBQXFDLEVBQWUsRUFBRTtBQUMxRSxJQUFFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7QUFDbkMsSUFBRSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUM3QyxRQUFJLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxDQUFDLEVBQUU7QUFDckMsWUFBTSxPQUFPLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMxQixTQUFLO0FBQ0wsS0FBRztBQUNILElBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQ3JELENBQUMsQ0FBQztBQUNGO0FBQXVCO0FBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ29tcG9uZW50LCBDb250ZW50Q2hpbGQsIEVsZW1lbnRSZWYsIEVtYmVkZGVkVmlld1JlZiwgSXRlcmFibGVEaWZmZXIsIEl0ZXJhYmxlRGlmZmVycywgTmdab25lLCBTaW1wbGVDaGFuZ2VzLCBUcmFja0J5RnVuY3Rpb24gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENlbGwsIENlbGxUeXBlLCBGb290ZXJIZWlnaHRGbiwgSGVhZGVyRm4sIEhlYWRlckhlaWdodEZuLCBJdGVtSGVpZ2h0Rm4gfSBmcm9tICdAaW9uaWMvY29yZSc7XG5cbmltcG9ydCB7IFByb3h5Q21wIH0gZnJvbSAnLi4vcHJveGllcy11dGlscyc7XG5cbmltcG9ydCB7IFZpcnR1YWxGb290ZXIgfSBmcm9tICcuL3ZpcnR1YWwtZm9vdGVyJztcbmltcG9ydCB7IFZpcnR1YWxIZWFkZXIgfSBmcm9tICcuL3ZpcnR1YWwtaGVhZGVyJztcbmltcG9ydCB7IFZpcnR1YWxJdGVtIH0gZnJvbSAnLi92aXJ0dWFsLWl0ZW0nO1xuaW1wb3J0IHsgVmlydHVhbENvbnRleHQgfSBmcm9tICcuL3ZpcnR1YWwtdXRpbHMnO1xuXG5leHBvcnQgZGVjbGFyZSBpbnRlcmZhY2UgSW9uVmlydHVhbFNjcm9sbCB7XG4gIC8qKlxuICAgKiBJdCBpcyBpbXBvcnRhbnQgdG8gcHJvdmlkZSB0aGlzXG4gICAqIGlmIHZpcnR1YWwgaXRlbSBoZWlnaHQgd2lsbCBiZSBzaWduaWZpY2FudGx5IGxhcmdlciB0aGFuIHRoZSBkZWZhdWx0XG4gICAqIFRoZSBhcHByb3hpbWF0ZSBoZWlnaHQgb2YgZWFjaCB2aXJ0dWFsIGl0ZW0gdGVtcGxhdGUncyBjZWxsLlxuICAgKiBUaGlzIGRpbWVuc2lvbiBpcyB1c2VkIHRvIGhlbHAgZGV0ZXJtaW5lIGhvdyBtYW55IGNlbGxzIHNob3VsZFxuICAgKiBiZSBjcmVhdGVkIHdoZW4gaW5pdGlhbGl6ZWQsIGFuZCB0byBoZWxwIGNhbGN1bGF0ZSB0aGUgaGVpZ2h0IG9mXG4gICAqIHRoZSBzY3JvbGxhYmxlIGFyZWEuIFRoaXMgaGVpZ2h0IHZhbHVlIGNhbiBvbmx5IHVzZSBgcHhgIHVuaXRzLlxuICAgKiBOb3RlIHRoYXQgdGhlIGFjdHVhbCByZW5kZXJlZCBzaXplIG9mIGVhY2ggY2VsbCBjb21lcyBmcm9tIHRoZVxuICAgKiBhcHAncyBDU1MsIHdoZXJlYXMgdGhpcyBhcHByb3hpbWF0aW9uIGlzIHVzZWQgdG8gaGVscCBjYWxjdWxhdGVcbiAgICogaW5pdGlhbCBkaW1lbnNpb25zIGJlZm9yZSB0aGUgaXRlbSBoYXMgYmVlbiByZW5kZXJlZC5cbiAgICovXG4gIGFwcHJveEl0ZW1IZWlnaHQ6IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIGFwcHJveGltYXRlIGhlaWdodCBvZiBlYWNoIGhlYWRlciB0ZW1wbGF0ZSdzIGNlbGwuXG4gICAqIFRoaXMgZGltZW5zaW9uIGlzIHVzZWQgdG8gaGVscCBkZXRlcm1pbmUgaG93IG1hbnkgY2VsbHMgc2hvdWxkXG4gICAqIGJlIGNyZWF0ZWQgd2hlbiBpbml0aWFsaXplZCwgYW5kIHRvIGhlbHAgY2FsY3VsYXRlIHRoZSBoZWlnaHQgb2ZcbiAgICogdGhlIHNjcm9sbGFibGUgYXJlYS4gVGhpcyBoZWlnaHQgdmFsdWUgY2FuIG9ubHkgdXNlIGBweGAgdW5pdHMuXG4gICAqIE5vdGUgdGhhdCB0aGUgYWN0dWFsIHJlbmRlcmVkIHNpemUgb2YgZWFjaCBjZWxsIGNvbWVzIGZyb20gdGhlXG4gICAqIGFwcCdzIENTUywgd2hlcmVhcyB0aGlzIGFwcHJveGltYXRpb24gaXMgdXNlZCB0byBoZWxwIGNhbGN1bGF0ZVxuICAgKiBpbml0aWFsIGRpbWVuc2lvbnMgYmVmb3JlIHRoZSBpdGVtIGhhcyBiZWVuIHJlbmRlcmVkLlxuICAgKi9cbiAgYXBwcm94SGVhZGVySGVpZ2h0OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBhcHByb3hpbWF0ZSB3aWR0aCBvZiBlYWNoIGZvb3RlciB0ZW1wbGF0ZSdzIGNlbGwuXG4gICAqIFRoaXMgZGltZW5zaW9uIGlzIHVzZWQgdG8gaGVscCBkZXRlcm1pbmUgaG93IG1hbnkgY2VsbHMgc2hvdWxkXG4gICAqIGJlIGNyZWF0ZWQgd2hlbiBpbml0aWFsaXplZCwgYW5kIHRvIGhlbHAgY2FsY3VsYXRlIHRoZSBoZWlnaHQgb2ZcbiAgICogdGhlIHNjcm9sbGFibGUgYXJlYS4gVGhpcyBoZWlnaHQgdmFsdWUgY2FuIG9ubHkgdXNlIGBweGAgdW5pdHMuXG4gICAqIE5vdGUgdGhhdCB0aGUgYWN0dWFsIHJlbmRlcmVkIHNpemUgb2YgZWFjaCBjZWxsIGNvbWVzIGZyb20gdGhlXG4gICAqIGFwcCdzIENTUywgd2hlcmVhcyB0aGlzIGFwcHJveGltYXRpb24gaXMgdXNlZCB0byBoZWxwIGNhbGN1bGF0ZVxuICAgKiBpbml0aWFsIGRpbWVuc2lvbnMgYmVmb3JlIHRoZSBpdGVtIGhhcyBiZWVuIHJlbmRlcmVkLlxuICAgKi9cbiAgYXBwcm94Rm9vdGVySGVpZ2h0OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFNlY3Rpb24gaGVhZGVycyBhbmQgdGhlIGRhdGEgdXNlZCB3aXRoaW4gaXRzIGdpdmVuXG4gICAqIHRlbXBsYXRlIGNhbiBiZSBkeW5hbWljYWxseSBjcmVhdGVkIGJ5IHBhc3NpbmcgYSBmdW5jdGlvbiB0byBgaGVhZGVyRm5gLlxuICAgKiBGb3IgZXhhbXBsZSwgYSBsYXJnZSBsaXN0IG9mIGNvbnRhY3RzIHVzdWFsbHkgaGFzIGRpdmlkZXJzIGJldHdlZW4gZWFjaFxuICAgKiBsZXR0ZXIgaW4gdGhlIGFscGhhYmV0LiBBcHAncyBjYW4gcHJvdmlkZSB0aGVpciBvd24gY3VzdG9tIGBoZWFkZXJGbmBcbiAgICogd2hpY2ggaXMgY2FsbGVkIHdpdGggZWFjaCByZWNvcmQgd2l0aGluIHRoZSBkYXRhc2V0LiBUaGUgbG9naWMgd2l0aGluXG4gICAqIHRoZSBoZWFkZXIgZnVuY3Rpb24gY2FuIGRlY2lkZSBpZiB0aGUgaGVhZGVyIHRlbXBsYXRlIHNob3VsZCBiZSB1c2VkLFxuICAgKiBhbmQgd2hhdCBkYXRhIHRvIGdpdmUgdG8gdGhlIGhlYWRlciB0ZW1wbGF0ZS4gVGhlIGZ1bmN0aW9uIG11c3QgcmV0dXJuXG4gICAqIGBudWxsYCBpZiBhIGhlYWRlciBjZWxsIHNob3VsZG4ndCBiZSBjcmVhdGVkLlxuICAgKi9cbiAgaGVhZGVyRm4/OiBIZWFkZXJGbjtcblxuICAvKipcbiAgICogU2VjdGlvbiBmb290ZXJzIGFuZCB0aGUgZGF0YSB1c2VkIHdpdGhpbiBpdHMgZ2l2ZW5cbiAgICogdGVtcGxhdGUgY2FuIGJlIGR5bmFtaWNhbGx5IGNyZWF0ZWQgYnkgcGFzc2luZyBhIGZ1bmN0aW9uIHRvIGBmb290ZXJGbmAuXG4gICAqIFRoZSBsb2dpYyB3aXRoaW4gdGhlIGZvb3RlciBmdW5jdGlvbiBjYW4gZGVjaWRlIGlmIHRoZSBmb290ZXIgdGVtcGxhdGVcbiAgICogc2hvdWxkIGJlIHVzZWQsIGFuZCB3aGF0IGRhdGEgdG8gZ2l2ZSB0byB0aGUgZm9vdGVyIHRlbXBsYXRlLiBUaGUgZnVuY3Rpb25cbiAgICogbXVzdCByZXR1cm4gYG51bGxgIGlmIGEgZm9vdGVyIGNlbGwgc2hvdWxkbid0IGJlIGNyZWF0ZWQuXG4gICAqL1xuICBmb290ZXJGbj86IEhlYWRlckZuO1xuXG4gIC8qKlxuICAgKiBUaGUgZGF0YSB0aGF0IGJ1aWxkcyB0aGUgdGVtcGxhdGVzIHdpdGhpbiB0aGUgdmlydHVhbCBzY3JvbGwuXG4gICAqIEl0J3MgaW1wb3J0YW50IHRvIG5vdGUgdGhhdCB3aGVuIHRoaXMgZGF0YSBoYXMgY2hhbmdlZCwgdGhlbiB0aGVcbiAgICogZW50aXJlIHZpcnR1YWwgc2Nyb2xsIGlzIHJlc2V0LCB3aGljaCBpcyBhbiBleHBlbnNpdmUgb3BlcmF0aW9uIGFuZFxuICAgKiBzaG91bGQgYmUgYXZvaWRlZCBpZiBwb3NzaWJsZS5cbiAgICovXG4gIGl0ZW1zPzogYW55W10gfCBudWxsO1xuXG4gIC8qKlxuICAgKiBBbiBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IG1hcHMgZWFjaCBpdGVtIHdpdGhpbiB0aGVpciBoZWlnaHQuXG4gICAqIFdoZW4gdGhpcyBmdW5jdGlvbiBpcyBwcm92aWRlZCwgaGVhdnkgb3B0aW1pemF0aW9ucyBhbmQgZmFzdCBwYXRoIGNhbiBiZSB0YWtlZCBieVxuICAgKiBgaW9uLXZpcnR1YWwtc2Nyb2xsYCBsZWFkaW5nIHRvIG1hc3NpdmUgcGVyZm9ybWFuY2UgaW1wcm92ZW1lbnRzLlxuICAgKlxuICAgKiBUaGlzIGZ1bmN0aW9uIGFsbG93cyB0byBza2lwIGFsbCBET00gcmVhZHMsIHdoaWNoIGNhbiBiZSBEb2luZyBzbyBsZWFkc1xuICAgKiB0byBtYXNzaXZlIHBlcmZvcm1hbmNlXG4gICAqL1xuICBpdGVtSGVpZ2h0PzogSXRlbUhlaWdodEZuO1xuXG4gIC8qKlxuICAgKiBBbiBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IG1hcHMgZWFjaCBpdGVtIGhlYWRlciB3aXRoaW4gdGhlaXIgaGVpZ2h0LlxuICAgKi9cbiAgaGVhZGVySGVpZ2h0PzogSGVhZGVySGVpZ2h0Rm47XG5cbiAgLyoqXG4gICAqIEFuIG9wdGlvbmFsIGZ1bmN0aW9uIHRoYXQgbWFwcyBlYWNoIGl0ZW0gZm9vdGVyIHdpdGhpbiB0aGVpciBoZWlnaHQuXG4gICAqL1xuICBmb290ZXJIZWlnaHQ/OiBGb290ZXJIZWlnaHRGbjtcblxuICAvKipcbiAgICogU2FtZSBhcyBgbmdGb3JUcmFja0J5YCB3aGljaCBjYW4gYmUgdXNlZCBvbiBgbmdGb3JgLlxuICAgKi9cbiAgdHJhY2tCeTogVHJhY2tCeUZ1bmN0aW9uPGFueT47XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIG1hcmtzIHRoZSB0YWlsIHRoZSBpdGVtcyBhcnJheSBhcyBkaXJ0eSwgc28gdGhleSBjYW4gYmUgcmUtcmVuZGVyZWQuICBJdCdzIGVxdWl2YWxlbnQgdG8gY2FsbGluZzogIGBgYGpzICAgICogdmlydHVhbFNjcm9sbC5jaGVja1JhbmdlKGxhc3RJdGVtTGVuLCBpdGVtcy5sZW5ndGggLSBsYXN0SXRlbUxlbik7ICAgICogYGBgXG4gICAqL1xuICAnY2hlY2tFbmQnOiAoKSA9PiB2b2lkO1xuICAvKipcbiAgICogVGhpcyBtZXRob2QgbWFya3MgYSBzdWJzZXQgb2YgaXRlbXMgYXMgZGlydHksIHNvIHRoZXkgY2FuIGJlIHJlLXJlbmRlcmVkLiBJdGVtcyBzaG91bGQgYmUgbWFya2VkIGFzIGRpcnR5IGFueSB0aW1lIHRoZSBjb250ZW50IG9yIHRoZWlyIHN0eWxlIGNoYW5nZXMuICBUaGUgc3Vic2V0IG9mIGl0ZW1zIHRvIGJlIHVwZGF0ZWQgY2FuIGFyZSBzcGVjaWZpbmcgYnkgYW4gb2Zmc2V0IGFuZCBhIGxlbmd0aC5cbiAgICovXG4gICdjaGVja1JhbmdlJzogKG9mZnNldDogbnVtYmVyLCBsZW4/OiBudW1iZXIpID0+IHZvaWQ7XG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBwb3NpdGlvbiBvZiB0aGUgdmlydHVhbCBpdGVtIGF0IHRoZSBnaXZlbiBpbmRleC5cbiAgICovXG4gICdwb3NpdGlvbkZvckl0ZW0nOiAoaW5kZXg6IG51bWJlcikgPT4gUHJvbWlzZTxudW1iZXI+O1xufVxuXG5AUHJveHlDbXAoe1xuICBpbnB1dHM6IFsnYXBwcm94SXRlbUhlaWdodCcsICdhcHByb3hIZWFkZXJIZWlnaHQnLCAnYXBwcm94Rm9vdGVySGVpZ2h0JywgJ2hlYWRlckZuJywgJ2Zvb3RlckZuJywgJ2l0ZW1zJywgJ2l0ZW1IZWlnaHQnLCAnaGVhZGVySGVpZ2h0JywgJ2Zvb3RlckhlaWdodCddLFxuICBtZXRob2RzOiBbJ2NoZWNrRW5kJywgJ2NoZWNrUmFuZ2UnLCAncG9zaXRpb25Gb3JJdGVtJ11cbn0pXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdpb24tdmlydHVhbC1zY3JvbGwnLFxuICB0ZW1wbGF0ZTogJzxuZy1jb250ZW50PjwvbmctY29udGVudD4nLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgaW5wdXRzOiBbXG4gICAgJ2FwcHJveEl0ZW1IZWlnaHQnLFxuICAgICdhcHByb3hIZWFkZXJIZWlnaHQnLFxuICAgICdhcHByb3hGb290ZXJIZWlnaHQnLFxuICAgICdoZWFkZXJGbicsXG4gICAgJ2Zvb3RlckZuJyxcbiAgICAnaXRlbXMnLFxuICAgICdpdGVtSGVpZ2h0JyxcbiAgICAnaGVhZGVySGVpZ2h0JyxcbiAgICAnZm9vdGVySGVpZ2h0JyxcbiAgICAndHJhY2tCeSdcbiAgXVxufSlcbmV4cG9ydCBjbGFzcyBJb25WaXJ0dWFsU2Nyb2xsIHtcblxuICBwcml2YXRlIGRpZmZlcj86IEl0ZXJhYmxlRGlmZmVyPGFueT47XG4gIHByaXZhdGUgZWw6IEhUTUxJb25WaXJ0dWFsU2Nyb2xsRWxlbWVudDtcbiAgcHJpdmF0ZSByZWZNYXAgPSBuZXcgV2Vha01hcDxIVE1MRWxlbWVudCwgRW1iZWRkZWRWaWV3UmVmPFZpcnR1YWxDb250ZXh0Pj4oKTtcblxuICBAQ29udGVudENoaWxkKFZpcnR1YWxJdGVtLCB7IHN0YXRpYzogZmFsc2UgfSkgaXRtVG1wITogVmlydHVhbEl0ZW07XG4gIEBDb250ZW50Q2hpbGQoVmlydHVhbEhlYWRlciwgeyBzdGF0aWM6IGZhbHNlIH0pIGhkclRtcCE6IFZpcnR1YWxIZWFkZXI7XG4gIEBDb250ZW50Q2hpbGQoVmlydHVhbEZvb3RlciwgeyBzdGF0aWM6IGZhbHNlIH0pIGZ0clRtcCE6IFZpcnR1YWxGb290ZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB6OiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSBpdGVyYWJsZURpZmZlcnM6IEl0ZXJhYmxlRGlmZmVycyxcbiAgICBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICApIHtcbiAgICB0aGlzLmVsID0gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50IGFzIEhUTUxJb25WaXJ0dWFsU2Nyb2xsRWxlbWVudDtcbiAgICB0aGlzLmVsLm5vZGVSZW5kZXIgPSB0aGlzLm5vZGVSZW5kZXIuYmluZCh0aGlzKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50cmFja0J5ICYmICdpdGVtcycgaW4gY2hhbmdlcykge1xuICAgICAgLy8gUmVhY3Qgb24gdmlydHVhbFNjcm9sbCBjaGFuZ2VzIG9ubHkgb25jZSBhbGwgaW5wdXRzIGhhdmUgYmVlbiBpbml0aWFsaXplZFxuICAgICAgY29uc3QgdmFsdWUgPSBjaGFuZ2VzWydpdGVtcyddLmN1cnJlbnRWYWx1ZTtcbiAgICAgIGlmICh0aGlzLmRpZmZlciA9PT0gdW5kZWZpbmVkICYmIHZhbHVlICE9IG51bGwpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLmRpZmZlciA9IHRoaXMuaXRlcmFibGVEaWZmZXJzLmZpbmQodmFsdWUpLmNyZWF0ZSh0aGlzLnRyYWNrQnkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENhbm5vdCBmaW5kIGEgZGlmZmVyIHN1cHBvcnRpbmcgb2JqZWN0ICcke3ZhbHVlfScuIFZpcnR1YWxTY3JvbGwgb25seSBzdXBwb3J0cyBiaW5kaW5nIHRvIEl0ZXJhYmxlcyBzdWNoIGFzIEFycmF5cy5gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nRG9DaGVjaygpIHtcbiAgICAvLyBhbmQgaWYgdGhlcmUgYWN0dWFsbHkgYXJlIGNoYW5nZXNcbiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5kaWZmZXIgIT09IHVuZGVmaW5lZCAmJiB0aGlzLml0ZW1zID8gdGhpcy5kaWZmZXIuZGlmZih0aGlzLml0ZW1zKSA6IG51bGw7XG4gICAgaWYgKGNoYW5nZXMgPT09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gVE9ETzogb3B0aW1pemVcbiAgICB0aGlzLmNoZWNrUmFuZ2UoMCk7XG4gIH1cblxuICBwcml2YXRlIG5vZGVSZW5kZXIoZWw6IEhUTUxFbGVtZW50IHwgbnVsbCwgY2VsbDogQ2VsbCwgaW5kZXg6IG51bWJlcik6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy56LnJ1bigoKSA9PiB7XG4gICAgICBsZXQgbm9kZTogRW1iZWRkZWRWaWV3UmVmPFZpcnR1YWxDb250ZXh0PjtcbiAgICAgIGlmICghZWwpIHtcbiAgICAgICAgbm9kZSA9IHRoaXMuaXRtVG1wLnZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KFxuICAgICAgICAgIHRoaXMuZ2V0Q29tcG9uZW50KGNlbGwudHlwZSksXG4gICAgICAgICAgeyAkaW1wbGljaXQ6IGNlbGwudmFsdWUsIGluZGV4IH0sXG4gICAgICAgICAgaW5kZXhcbiAgICAgICAgKTtcbiAgICAgICAgZWwgPSBnZXRFbGVtZW50KG5vZGUpO1xuICAgICAgICB0aGlzLnJlZk1hcC5zZXQoZWwsIG5vZGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZSA9IHRoaXMucmVmTWFwLmdldChlbCkhO1xuICAgICAgICBjb25zdCBjdHggPSBub2RlLmNvbnRleHQ7XG4gICAgICAgIGN0eC4kaW1wbGljaXQgPSBjZWxsLnZhbHVlO1xuICAgICAgICBjdHguaW5kZXggPSBjZWxsLmluZGV4O1xuICAgICAgfVxuICAgICAgLy8gcnVuIHN5bmMgY2hhbmdlIGRldGVjdGlvbnNcbiAgICAgIG5vZGUuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgcmV0dXJuIGVsO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb21wb25lbnQodHlwZTogQ2VsbFR5cGUpIHtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ2l0ZW0nOiByZXR1cm4gdGhpcy5pdG1UbXAudGVtcGxhdGVSZWY7XG4gICAgICBjYXNlICdoZWFkZXInOiByZXR1cm4gdGhpcy5oZHJUbXAudGVtcGxhdGVSZWY7XG4gICAgICBjYXNlICdmb290ZXInOiByZXR1cm4gdGhpcy5mdHJUbXAudGVtcGxhdGVSZWY7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGUgZm9yIHZpcnR1YWwgaXRlbSB3YXMgbm90IHByb3ZpZGVkJyk7XG4gIH1cbn1cblxuY29uc3QgZ2V0RWxlbWVudCA9ICh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8VmlydHVhbENvbnRleHQ+KTogSFRNTEVsZW1lbnQgPT4ge1xuICBjb25zdCByb290Tm9kZXMgPSB2aWV3LnJvb3ROb2RlcztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290Tm9kZXMubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAocm9vdE5vZGVzW2ldLm5vZGVUeXBlID09PSAxKSB7XG4gICAgICByZXR1cm4gcm9vdE5vZGVzW2ldO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ3ZpcnR1YWwgZWxlbWVudCB3YXMgbm90IGNyZWF0ZWQnKTtcbn07XG4iXX0=